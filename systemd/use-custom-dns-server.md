# Use custom DNS server

<!-- tl;dr starts -->

I would like to use Cloudflare DNS servers for both locally (inside my browser) and globally across OS.

<!-- tl;dr ends -->

## NetworkManager

Using **NetworkManager**, you can also configure your DNS settings.

Add custom DNS servers:

```sh
# Ethernet, ipv4, Cloudflare first, Google later
nmcli connection modify Ethernet ipv4.dns "1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4"
nmcli connection modify Ethernet ipv4.ignore-auto-dns yes

# Ethernet, ipv6, Cloudflare first, Google later
nmcli connection modify Ethernet ipv6.dns "2606:4700:4700::1111 2606:4700:4700::1001 2001:4860:4860::8888 2001:4860:4860::8844"
nmcli connection modify Ethernet ipv6.ignore-auto-dns yes

# Do the same with Wifi and Hotspot devices...
```

Apply NetworkManager's DNS settings:

```sh
# use DNS stub server
sudo ln -sf /run/NetworkManager/no-stub-resolv.conf /etc/resolv.conf

# ignore DNS stub server
sudo ln -sf /run/NetworkManager/resolv.conf /etc/resolv.conf
```

Changes are made 2 files, as far as I know:

1. `/etc/NetworkManager/system-connections/Ethernet.nmconnection`:

```conf

...

[ipv4]
dns=1.1.1.1;1.0.0.1;8.8.8.8;8.8.4.4;
ignore-auto-dns=true
method=auto

...

[ipv6]
dns=2606:4700:4700::1111;2606:4700:4700::1001;2001:4860:4860::8888;2001:4860:4860::8844;
ignore-auto-dns=true
method=auto

...

```

2. `/run/NetworkManager/no-stub-resolv.conf`

```
# Generated by NetworkManager
nameserver 1.1.1.1
nameserver 1.0.0.1
nameserver 8.8.8.8
# NOTE: the libc resolver may not support more than 3 nameservers.
# The nameservers listed below may not be recognized.
nameserver 8.8.4.4
nameserver 2606:4700:4700::1111
nameserver 2606:4700:4700::1001
nameserver 2001:4860:4860::8888
nameserver 2001:4860:4860::8844
```

This file is automatically generated whenever NetworkManager is restarted by running `sudo systemctl restart NetworkManager`. Tt seems there shouldn't be more than 3 nameservers, but since specifying more shouldn't cause any harm, I shall leave it that way.

There is also a file named: `/run/NetworkManager/resolv.conf` that delegates its work to DNS stub resolver:

```conf
nameserver 127.0.0.53
options edns0 trust-ad
```

Check NetworkManager DNS settings:

```sh
nmcli device show | grep 'DNS'
```

Use `NetworkManager` if you want to configure DNS settings per-device

## systemd-resolved

Read more information inside [freedesktop's "Network Name Resolution configuration files"](https://www.freedesktop.org/software/systemd/man/latest/resolved.conf.html)

In my current system, Fedora KDE 40, DNS is handled by `systemd-resolved` by default. To add custom DNS servers, add `DNS=` and `FallbackDNS=` entries into `/etc/systemd/resolved.conf` (or better, drop-ins like `/etc/systemd/resolved.conf.d/00-custom.conf`). I'm personally using a hybrid approach due to me being unbeknown to drop-ins.

There is a irritating bug that's preventing me from using custom DNS server right after system start-up. In fact, **no DNS server can be used** at the moment even though I've set up `FallbackDNS=` to point back to my router's gateway (the default DNS server). The problem usually resolved itself after 5-7 minutes.

That's why I disable `systemd-resolved` "cleanly", the "unclean" way is to run `sudo systemctl disable --now systemd-resolved && sudo systemctl mask systemd-resolved`, but unfortunately `systemd-resolved` is the one who handled DHCP, so it has to be enabled and running all the time, but DNS resolver is stripped off from it.

[Brian's blog post: "Disable systemd-resolved cleanly"](https://www.turek.dev/posts/disable-systemd-resolved-cleanly/) talks about how `systemd-resolved` runs a "stub" DNS server. It acts as a local DNS proxy/cache running on `127.0.0.53:53` and manages DNS settings centrally for the system.
